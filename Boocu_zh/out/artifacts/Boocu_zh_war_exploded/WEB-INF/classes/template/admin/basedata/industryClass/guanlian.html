<!--
  ~ Copyright (c) 2018. Lorem ipsum dolor sit amet, consectetur adipiscing elit.
  ~ Morbi non lorem porttitor neque feugiat blandit. Ut vitae ipsum eget quam lacinia accumsan.
  ~ Etiam sed turpis ac ipsum condimentum fringilla. Maecenas magna.
  ~ Proin dapibus sapien vel ante. Aliquam erat volutpat. Pellentesque sagittis ligula eget metus.
  ~ Vestibulum commodo. Ut rhoncus gravida arcu.
  -->

<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN"
        "http://www.w3.org/TR/html4/strict.dtd">

<html lang="en">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=9">
    </meta>
    <title>云图商城-后台管理</title>
    <style type="text/css">
        body {
            margin: 0px;
            font-family: Arial, "宋体", Verdana, sans-serif;
            font-size: 12px;
        }
        html, body {
            padding: 0;
            margin: 0;
            overflow-x: hidden;
            overflow-y: auto;
        }

        dl, dd {
            margin: 0px
        }

        ul {
            list-style-type: none;
            margin: 0px;
            padding: 0px;
        }
    </style>

    <script type="text/javascript" src="/adminthemes/new/js/jquery-1.8.3.min.js"></script>
    <script type="text/javascript" src="/adminthemes/new/js/jquery-form-2.33.js"></script>
    <script type="text/javascript" src="/statics/js/area_sql.js"></script>
    <link rel="stylesheet" type="text/css" href="/adminthemes/new/js/easyui-1.6.7/themes/gray/easyui.css"/>
    <link rel="stylesheet" type="text/css" href="/adminthemes/new/js/easyui-1.6.7/themes/icon.css"/>
    <script type="text/javascript" src="/adminthemes/new/js/easyui-1.6.7/jquery.easyui.min.js"></script>
    <script type="text/javascript" src="/adminthemes/new/js/easy-ui/easyui-lang-zh_CN.js"></script>
    <script type="text/javascript" src="/adminthemes/new/js/jquery.blockUI.js"></script>
    <script type="text/javascript" src="/adminthemes/new/js/jquery.loading.js"></script>
    <link href="/adminthemes/new/css/main.css" rel="stylesheet" type="text/css"/>
    <link href="/adminthemes/new/css/style.css" rel="stylesheet" type="text/css"/>
    <script type="text/javascript" src="/adminthemes/js/BooCu.js"></script>
    <script type="text/javascript" src="/adminthemes/new/js/ajaxupload.3.9.js"></script>
    <script type="text/javascript" src="/frontthemes/js/easyuiUtil.js"></script>
    [#include '/template/admin/include/common.html']

</head>
<body>
<div class="easyui-panel" style="width:800px;max-width:800px;padding:30px 60px;">
    <div style="margin-bottom:20px">
        选择仪器名称
        <select style="width: 292px; line-height: 36px; height: 36px;"
                name="yiqiName"
                id="yiqiName" /> </select>

        <a href="javascript:void(0)" class="button blueButton"
           data-options="iconCls:'icon-add',plain:true" onclick="getSelected()">建立关联</a>
        <!--<input id="yiqi" class="easyui-combotree"
               data-options="url:'/yiqi/combotreeData.json',method:'get',label:'选择仪器分类',labelPosition:'top'"
               style="width:200px">
        <a href="javascript:void(0)" class="button blueButton"
           data-options="iconCls:'icon-add',plain:true" onclick="getSelected()">关联</a>-->
    </div>

</div>

<table  style="width:700px;height:450px" id="chanpin"></table>
<!--<table title="选择对应产品" class="easyui-treegrid" style="width:700px;height:450px" id="chanpin"
       data-options="
				url: '/chanpin/combotreeData.json',
				lines: true,
				cascadeCheck:false,
				method: 'get',
				rownumbers: true,
				idField: 'id',
				treeField: 'name'
			">
    <thead>
    <tr>
        <th data-options="field:'name',formatter:formatcheckbox" width="300" align="left">名称</th>
        <th data-options="field:'nameEn'" width="200">英文名称</th>
        <th data-options="field:'parentid'" width="50">父节点</th>
    </tr>
    </thead>
</table>-->
<script type="application/javascript">
    function  getValue() {
       alert($('#yiqiName').combobox('getValue'))
    }
    function collapseAll(){
        $('#chanpin').treegrid('collapseAll');
    }
    function expandAll(){
        $('#chanpin').treegrid('expandAll');
    }
    function expandTo(){
        $('#chanpin').treegrid('expandTo',10401);
    }
    $('#yiqiName').combotree({
        width:300,
        method:'get',
        url:'/admin/basedata/productclass/combotreeData.json',
        editable:true,
        required: true,
        //onlyLeafCheck:true,
        onBeforeSelect:function (node) {
            var tree = $('#yiqiName').combotree('tree');// get the tree object
            if (!$("#yiqiName").combotree("tree").tree('isLeaf', node.target)) {
                return false;
            }
        },
        onSelect:function (row) {
            if(row.id!=""){

                $(":checkbox").prop("checked","")
                $.ajax({
                    url: "/admin/industyClass/expandByYiqiId.jspx",
                    data:{"yiqiId":row.id},
                    dataType:"json",
                    type:"POST",
                    success: function (result) {
                        for(var i=0;i<result.length;i++){

                            var node=$('#chanpin').treegrid('find',result[i].id);
                            //$("#datagrid-row-r2-2-"+result[i].chanpinId)[0].children[0].children[0].children[3].firstChild.checked='checked'
                            $("#datagrid-row-r1-2-"+result[i].id+" input")[0].checked=true;
                        }
                    }
                });
            }
        },
        onLoadSuccess:function () {
            //这里是下面的树先加载完 后加载上面的
            //放在这里确保上面的两个数结构都加载完毕再做操作
            // find a node and then select it
            var treeObj = $('#yiqiName').combotree('tree');// get the tree object
            var node =treeObj.tree("find",${yiqiId})
            if(node!=null){
                treeObj.tree('select',node.target)//get selected node
                $('#yiqiName').combotree('setValue',${yiqiId})
            }
        }
    });

    $('#chanpin').treegrid({
        title:'选择对应产品',
        url:'/admin/industyClass/combotreeData.json',
        idField:'id',
        treeField:'text',
        lines: true,
        cascadeCheck:false,
        method: 'get',
        rownumbers: true,
        columns:[[
            {title:'名称',field:'text',width:300,formatter:formatcheckbox,align:'left'},
        ]],
        toolbar: [{
            iconCls: 'accordion-expand',
            text:"全部展开",
            handler: function(){expandAll()}
        },'-',{
            text:"全部折叠",
            iconCls: 'accordion-collapse',
            handler: function(){collapseAll()}
        }],
        onClickCell: function (rowIndex, field, value) {
            if (rowIndex == "text") {
                console.log(field.id)
                $(".tree-title input").each(function () {
                    if (this.parentElement.parentElement.parentElement.parentElement.getAttribute("node-id") == field.id) {
                        this.checked = this.checked ? false : true;
                    }
                });
            }
        }
    });

    function formatcheckbox(value, row, index) {
        if(row.children==undefined){
            return "<input type='checkbox' onclick='check(this,event)'/>" + value;
        }else{
            return  value;
        }

    }
    function check(obj,event) {
        this.checked=true;
        //阻止父类点击事件
       event.stopPropagation()
    }
    //获取选中的结点
    function getSelected() {
        //var yiqiid = $('#yiqi').combotree('getValue');
        var yiqiid = $('#yiqiName').combobox('getValue');

        var chanpinIdList = []
        $("input:checked").each(function () {
            chanpinIdList.push(this.parentElement.parentElement.parentElement.parentElement.getAttribute("node-id"))
        });
        if (yiqiid == "") {
            alert("请选择一个仪器")
            return false;
        }
        if (chanpinIdList == "") {
            alert("至少选择一个要关联的产品")
            return false;
        }
        $.ajax({
            url: "/admin/industyClass/addGuanlian.jspx",
            data:{"yiqiid":yiqiid,"chanpinIdList":chanpinIdList},
            dataType:"json",
            type:"POST",
            success: function (result) {
                if(result.type=="success"){
                    alert("关联成功")
                    newTab("仪器基础数据库","/admin/industyClass/toProductclassAndYiqiList.jspx")
                }else{
                    alert("关联失败，服务器出错了")
                }
            }
        });
    }
</script>
<!--<div class="easyui-panel" style="width:1200px;max-width:1500px;padding:30px 60px;">
<div style="margin-bottom:20px">
    <select id="yiqi_combogrid" class="easyui-combogrid" style="width:200px" data-options="
                panelWidth: 600,
                idField: 'yiqiId',
                textField: 'name',
                url: '/yiqi/getYiqi.jspx',
                pagination:true,
                method: 'get',
                columns: [[
                    {field:'yiqiId',title:'Item ID',width:40},
                    {field:'name',title:'名称',width:120},
                    {field:'nameEn',title:'英文名称',width:120,align:'center'},
                    {field:'parentid',title:'父节点',width:80,align:'center'},
                    {field:'leaf',title:'是否子节点',width:40},
                    {field:'remark',title:'备注',width:60,align:'center'}
                ]],
                fitColumns: true,
                label: '选择仪器:',
                labelPosition: 'top'
            ">
    </select>
    <a href="javascript:void(0)" class="button blueButton"
       data-options="iconCls:'icon-add',plain:true" onclick="contact()" >关联</a>
</div>
</div>
<table class="easyui-datagrid" id="chanpinList"
       data-options="url:'/chanpin/getChanpin.jspx',pageList: [5,10,15,20],pageSize:10,fitColumns:'true'"
       pagination="true" id="chanpinid" sortName="id" sortOrder="desc" >
    <thead>
    <tr>
        <th data-options="field:'chanpinId',checkbox:true"></th>
        <th data-options="field:'name',width:$(this).width()*0.1,sortable:'true'">产品名称 </th>
        <th data-options="field:'nameEn',width:$(this).width()*0.1,sortable:'true'" >名称(英文)</th>
        <th data-options="field:'parentid',width:$(this).width()*0.1,sortable:'true'" >父分类</th>
        <th data-options="field:'leaf',width:$(this).width()*0.2,sortable:'true'">是否是子节点</th>
        <th data-options="field:'sort',width:$(this).width()*0.1,sortable:'true'">排序</th>
        <th data-options="field:'remark',width:$(this).width()*0.1,sortable:'true'">备注</th>
        &lt;!&ndash;<th data-options="field:'action',width:$(this).width()*0.1,align:'center'">操作</th>&ndash;&gt;
    </tr>
    </thead>
</table>-->

</body>
</html>