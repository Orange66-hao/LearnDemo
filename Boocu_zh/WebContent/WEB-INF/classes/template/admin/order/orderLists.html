<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN"
   "http://www.w3.org/TR/html4/strict.dtd">

<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta http-equiv="X-UA-Compatible" content="IE=9" > </meta>
<title>云图商城-后台管理</title>
<style type="text/css">
body{
	margin:0px;
	font-family:Arial,"宋体",Verdana,sans-serif;
	font-size:12px;
}
html,body {padding: 0;margin: 0; overflow-x:hidden; overflow-y:auto;}
dl,dd{margin:0px}
ul{
	list-style-type:none;
	margin:0px;
	padding:0px;
	
}
</style>
<script type="text/javascript" src="/adminthemes/new/js/jquery-1.8.3.min.js"></script>
<link rel="stylesheet" type="text/css" href="/adminthemes/new/js/easy-ui/themes/gray/easyui.css"/>    
<link rel="stylesheet" type="text/css" href="/adminthemes/new/js/easy-ui/themes/icon.css"/>  
<script type="text/javascript" src="/adminthemes/new/js/easy-ui/jquery.easyui.min.js"></script>
<script type="text/javascript" src="/adminthemes/new/js/easy-ui/easyui-lang-zh_CN.js"></script>
<script type="text/javascript" src="/adminthemes/new/js/jquery.blockUI.js"></script>
<script type="text/javascript" src="/adminthemes/new/js/jquery.loading.js"></script>
<link href="/adminthemes/new/css/main.css" rel="stylesheet" type="text/css" />
<link href="/adminthemes/new/css/style.css" rel="stylesheet" type="text/css" />
<link href="/statics/front/css/xcConfirm.css" rel="stylesheet" type="text/css" />
<link href="/statics/css/daterangepicker.css" rel="stylesheet" type="text/css" />
<script src="/statics/front/js/xcConfirm.js"></script>
<script src="/statics/js/moment.min.js"></script>
<script src="/statics/js/jquery.daterangepicker.js"></script>
<script type="text/javascript" src="/adminthemes/new/js/jquery-form-2.33.js"></script>

<script type="text/javascript">
//初始化数据集
$(function(){
	//隐藏的列
	$("#orderList").datagrid('hideColumn', 'statusNum');
	$("#orderList").datagrid('hideColumn', 'id');
	
	//加载时间插件
	$('#createTime').dateRangePicker();
});
</script>
[#include '/template/admin/include/common.html']

</head>
<body>
<div id="loading"></div>
<div class="main">
	<div class="easyui-tabs">
		<div title="订单列表" style="padding:10px;">
			<div class="clear height10"></div>
			<form id="memberform1">
				<div id="tb" style="height: auto">
					<span style="float: left;"> 
						<span id="simpleSearch">
							<input id="orderNumber" class="input_text" type="text" value="" size="30" style="width: 300px;" placeholder="订单号" name="orderNumber">
							<input id="email" class="input_text" type="text" value="" size="30" style="width: 300px;" placeholder="电子邮件" name="email">
							<input id="buyName" class="input_text" type="text" value="" size="30" style="width: 300px;" placeholder="购货人" name="buyName">
							<input id="recvName" class="input_text" type="text" value="" size="30" style="width: 300px;" placeholder="收货人" name="recvName"><br/>
							<input id="mobile" class="input_text" type="text" value="" size="30" style="width: 300px;" placeholder="手机" name="mobile">
							订单状态：
							<select id="status" name="status" onchange="searchCon()">
								<option value="-100">- 订单状态 -</option>
								<option value="-1">买家取消</option>
								<option value="0">待支付</option>
								<option value="1">确认订单</option>
								<option value="2">仓库开始拣货</option>
								<option value="3">打包中</option>
								<option value="4">通知商家揽件</option>
								<option value="5">未发货时申请退款</option>
								<option value="6">待收货</option>
								<option value="7">卖家取消订单</option>
								<option value="8">已收货</option>
								<option value="9">交易完成</option>
								<option value="10">收货后申请退货</option>
								<option value="11">退款完成</option>
								<option value="12">退货完成</option>
								<option value="13">交易关闭</option>
							</select>
							
							&nbsp;&nbsp;支付方式：
							<select id="payType" name="payType" onchange="searchCon()">
								<option value="-1">- 支付方式 -</option>
								<option value="1">微信</option>
								<option value="2">支付宝</option>
								<option value="3">汇款</option>
							</select>
							&nbsp;&nbsp; 下单时间：<input id="createTime" class="input_text" value="" size="30" name="createTime"> 
							<a href="javascript:;" class="easyui-linkbutton" data-options="plain:true" onclick="searchCon()">搜索</a>
						</span>
					</span>
				</div>
				
				<div class="clear height10"></div>
				<div class="shadowBoxWhite tableDiv"></div>
			</form>
			<div class="shadowBoxWhite tableDiv">
				<div id="noproc">
					<table class="easyui-datagrid"
						data-options="url:'/adminOrder/orderDataJson.json',pageList: [5,10,15,20],pageSize:10"
						pagination="true" id="orderList" sortName="id" sortOrder="desc">
						<thead>
							<tr>
							 	<th data-options="field:'name',width:300,align:'center'" >商品名称</th>
							 	<th data-options="field:'statusNum'" ></th>
							 	<th data-options="field:'id'" ></th>
							 	<th data-options="field:'userName',width:100,align:'center'" >收货人</th>
							 	<th data-options="field:'orderNum',width:200,align:'center'" >订单编号</th>
								<th data-options="field:'status',width:100,align:'center'">状态</th>
								<th data-options="field:'address',width:400,align:'center'">收货地址</th>
								<th data-options="field:'mobile',width:150,align:'center'">联系电话</th>
								<th data-options="field:'proPrice',width:80,align:'center'">商品总价</th>
								<th data-options="field:'disPrice',width:80,align:'center'" formatter="dispriceFormate">打折金额</th>
								<th data-options="field:'payCompleteTime',width:150,align:'center'">支付完成时间</th>
								<th data-options="field:'payType',width:80,align:'center'">支付方式</th>
								<th data-options="field:'payAmount',width:80,align:'center'">支付金额</th>
								<th data-options="field:'tradeCompleteTime',width:150,align:'center'">交易完成时间</th>
								<th data-options="field:'null',width:70,align:'center'" formatter="opera">操作</th>
							</tr>
						</thead>
					</table>
				</div>
			</div>
		</div>
	</div>
	<div id="divdia" style="display: none;"></div>
</div>

<script type="text/javascript">

function searchCon(){
	
	var orderNumber = $("#orderNumber").val();
	var email = $("#email").val();
	var buyName = $("#buyName").val();
	var recvName = $("#recvName").val();
	var mobile = $("#mobile").val();
	var status = $("#status option:selected ").val();
	var payType = $("#payType option:selected ").val();
	
	//时间范围字符串 需要截取
	var createTime = $("#createTime").val();
	
	$("#orderList").datagrid("load",{
		orderNumber:orderNumber,
		buyName:buyName,
		recvName:recvName,
		mobile:mobile,
		status:status,
		createTime:createTime,
		payType:payType,
		email:email,
		page:1
	});
}

function opera(value, row, index){
	var stat = row.statusNum;
	var ghtml = "";
	if(stat == 1 || stat == 1 || stat == 2 || stat == 3 || stat == 4 || stat == 5 || stat == 6 || stat == 8 || stat == 9 || stat == 10 || stat == 11){
		 ghtml += "<a class='edit' title='更改状态' href='javascript:void(0);' onclick='upEdit(" + row.id + ")' ></a>";		
	}
	/*
	ghtml += "<a class='issue' title='查看' href='javascript:void(0);' onclick='seek(" + row.id + ")'></a>";
	*/
	if(stat == 13 || stat == -1){
		ghtml += "<a class='delete' title='删除' href='javascript:void(0);' onclick='delOrder(" + row.id + ")' ></a>";
	}
	return ghtml;
}

function upEdit(id){
    var map = {}; // Map map = new HashMap();
    if (id != null)
    {
        map["href"] = "/adminOrder/findDetail.jspx?id=" + id;
        map["formId"] = "#editStatForm";
        map["title"] = "修改订单状态";
        map["loadshow"] = "正在刷新数据......";
        map["url"] = "/adminOrder/updateStat.jspx";
        map["text"] = "确定";
    }
    map["divDialog"] = "#divdia";
    map["gridreload"] = "#orderList";
    addDialog (map);
}

function seek(id){
	
}

function addDialog (map){
    $ (map["divDialog"]).show ();
    $ (map["divDialog"]).dialog (
    {
        title : map["title"],
        width : 500,
        height : 400,
        closed : false,
        cache : false,
        href : map["href"],
        modal : true,buttons : [ {
			text : map['text'],
			iconCls : 'icon-ok',
			handler : function() {
				var savebtn = $(this);
　　				var disabled=savebtn.hasClass("l-btn-disabled");
　　				if(!disabled){
　　					submitForm1(map,savebtn);
				}
			}
		} ]
    });
}

//查看
function submitForm1 (map)
{
    $.Loading.show (map["loadshow"]);
    var options =
    {
        url : map["url"],
        type : "POST",
        success : function (result)
        {
          
          $ (map["divDialog"]).dialog ('close');
          $ (map["gridreload"]).datagrid ('reload');
          $ (map["orderList"]).datagrid ('reload');
          $.Loading.hide ();
        },
        error : function (e)
        {
         alert ("出现错误 ，请重试");
        }
    };
    $ (map["formId"]).ajaxSubmit (options);
}

function delOrder(id){
	window.wxc.xcConfirm("确定删除？删除后不能恢复！", window.wxc.xcConfirm.typeEnum.warning,
	{onOk:function(){
		$.post("/adminOrder/delOrder.jspx",{"orderId":id+","},
		function(data){
			if(data == "ok"){
				window.wxc.xcConfirm("删除成功！", window.wxc.xcConfirm.typeEnum.success,
				{onOk:function(){
					//刷新页面
					$("#orderList").datagrid('reload');
				}});
			}else{
				window.wxc.xcConfirm("删除失败，请稍后再试！", window.wxc.xcConfirm.typeEnum.error);
			}
		})
	}});
}

function dispriceFormate(value, row, index) {
	var val = "<a class='details' title='打折价格' href='javascript:void(0);' on onclick='editDisprice(\""+row.id+"\",\""+row.disPrice+"\",\""+row.proPrice+"\",\""+row.statusNum+"\")'>"+row.disPrice+"</a>";
	return val;
}

function editDisprice(id,disprice,sumprice,status){
	if(status > 0){
		window.wxc.xcConfirm("该订单不是待支付状态，不能修改折扣金额！", window.wxc.xcConfirm.typeEnum.warning);
	}else{
		window.wxc.xcConfirm("当前打折金额:￥"+disprice+"，新折扣金额:", window.wxc.xcConfirm.typeEnum.input,{
			onOk:function(v){
				if(Math.abs(v) >= sumprice){
					window.wxc.xcConfirm("折扣金额("+Math.abs(v)+")不能超出商品总金额("+sumprice+") ！", window.wxc.xcConfirm.typeEnum.warning);						
				}else
				{
					$.post("/adminOrder/updateDisCount.jspx",
					{"orderId":id,"disPrice":v},function(data){
						if(data == "ok"){
							window.wxc.xcConfirm("修改成功！", window.wxc.xcConfirm.typeEnum.success,
							{onOk:function(){
								//刷新页面
								$("#orderList").datagrid('reload');
							}});
						}else{
							window.wxc.xcConfirm("修改失败，请稍后再试！", window.wxc.xcConfirm.typeEnum.error);
						}
					});
				}
			}
		});
	}
}
</script>
</body>
</html>