
<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN"
   "http://www.w3.org/TR/html4/strict.dtd">

<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta http-equiv="X-UA-Compatible" content="IE=9">
</meta>
<title>云图商城-后台管理</title>
<style type="text/css">
body {
	margin: 0px;
	font-family: Arial, "宋体", Verdana, sans-serif;
	font-size: 12px;
}

html, body {
	padding: 0;
	margin: 0;
	overflow-x: hidden;
	overflow-y: auto;
}

dl, dd {
	margin: 0px
}

ul {
	list-style-type: none;
	margin: 0px;
	padding: 0px;
}

.input_text2{
	border: 1px solid #D7D7D7;
	border-radius: 3PX;
	/*height: 14PX;*/
	padding: 7px 0 7px 5px;
	line-height: 14PX;
	font-size: 12px;
	display: inline-block;
	width:150px;
}

.input_text2:focus {
	border: 1px solid #06F;
	box-shadow: inset 0 1px 2px rgba(0, 102, 255, 0.3);
}

</style>
<script type="text/javascript" src="/editor/ckeditor362/ckeditor.js"></script>
<script type="text/javascript"
	src="/adminthemes/new/js/jquery-1.8.3.min.js"></script>
<script type="text/javascript"
	src="/adminthemes/new/js/jquery-form-2.33.js"></script>
<script type="text/javascript" src="/statics/js/area_sql.js"></script>
<link rel="stylesheet" type="text/css"
	href="/adminthemes/new/js/easy-ui/themes/gray/easyui.css" />
<link rel="stylesheet" type="text/css"
	href="/adminthemes/new/js/easy-ui/themes/icon.css" />
<script type="text/javascript"
	src="/adminthemes/new/js/easy-ui/jquery.easyui.min.js"></script>
<script type="text/javascript"
	src="/adminthemes/new/js/easy-ui/easyui-lang-zh_CN.js"></script>
<script type="text/javascript"
	src="/adminthemes/new/js/jquery.blockUI.js"></script>
<script type="text/javascript"
	src="/adminthemes/new/js/jquery.loading.js"></script>
<link href="/adminthemes/new/css/main.css" rel="stylesheet"
	type="text/css" />
<link href="/adminthemes/new/css/style.css" rel="stylesheet"
	type="text/css" />
<script type="text/javascript" src="/adminthemes/js/BooCu.js"></script>
<script type="text/javascript"
	src="/adminthemes/new/js/ajaxupload.3.9.js"></script>
<script type="text/javascript" src="/frontthemes/js/easyuiUtil.js"></script>


[#include '/template/admin/include/common.html']

</head>
<body>

	<div id="bookinfo" style="display: none;"></div>
	<div id="loading"></div>
	<div class="main">
		<form id="memberform">
			<div id="tb" style="height: auto">
				[#if currentUser.username=='lwz'||currentUser.username=='admin']
				<a href="javascript:append()" class="button blueButton"
					data-options="iconCls:'icon-add',plain:true" onclick="javascript:void(0)">添加</a>
				<a href="javascript:void(0)" class="easyui-linkbutton"
					data-options="plain:true" onclick="del()">删除</a>
				[/#if]
					<span style="float: right;"> 
				<span style="float: right;margin-right: 100px;">

				&nbsp;&nbsp;&nbsp;&nbsp;
				<span >

				<span >
				产品名称：
				 <input style="width: 200px; height: 30px;"
                        class="easyui-combobox"
                        url="/admin/industyClass/combotreeData.json?getSanji=true" name="industryClassName" data-options="multiple:false,valueField:'id',textField:'text',editable:true"
                        id="industryClassName"/>

				</span>
				<span >
				仪器名称：
				 <input style="width: 200px; height: 30px;"
                        class="easyui-combobox"
                        url="/admin/basedata/productclass/combotreeData.json?getSanji=true" name="productName" data-options="multiple:false,valueField:'id',textField:'text',editable:true"
                        id="productName"/>
				</span>
                <span>
				品牌名称：
				<select style="width: 140px; height: 36px;"  class="easyui-combobox" name="brand" id="brand"></select>
				</span>
                     <span>
				型号名称：
				<input style="width: 140px; height: 30px;display: inline-block;font-size: 12px"  name="model" id="model"placeholder="请输入型号名称"></input>
				</span>

                    <!--创建时间：
                    <select id="create_date_all" name="create_date_all" class="input_text"  style="width: 100px; height: 32px;">
                    <option value='all' selected="selected">全部
                    <option value='3'>三天内
                    <option value='7'>本周内
                    <option value='30'>本月内
                </select>-->
				</span>
				&nbsp;&nbsp;&nbsp;&nbsp;
                    <!-- <span id="simpleSearch">
                        <input id="searchKeyword" class="input_text" type="text" value="" size="30" style="width: 300px;"
                        placeholder="请输入公司名称" name="searchKeyWord">  -->
				<a href="javascript:void(0)" class="easyui-linkbutton"
                   data-options="plain:true" onclick="searchIndustryClass();">搜索</a>
				</span>
			</span>
            </div>

			<div class="clear height10"></div>
			<div class="shadowBoxWhite tableDiv">
				<table class="easyui-datagrid" id="memberdata"
					data-options="url:'/admin/brandAndModel/getData.json',pageList: [5,10,15,20],pageSize:10,fitColumns:'true',rownumbers:'true'" nowrap="false"
					pagination="true" sortName="bm.modify_date" sortOrder="desc" idField="i_id" treeField="name" checkbox="true">
					<thead>
						<tr>
						<th data-options="field:'i_id',checkbox:true"></th>
                        <th data-options="field:'i_name',width:$(this).width()*0.1,align: 'center'" formatter="formatName">产品名称</th>
                        <th data-options="field:'p_name',width:$(this).width()*0.1,align: 'center'" formatter="formatupproductclass">仪器名称</th>
                        <th data-options="field:'bmList',width:$(this).width()*0.3,align: 'center'" formatter="formatBrandAndModel">品牌型号</th>
                        <th data-options="field:'i_modify_date',width:$(this).width()*0.1,align: 'center',sortable:'true'" formatter="formdate">更新时间</th>
                        <th data-options="field:'action',width:$(this).width()*0.06,align:'center'"
                                formatter="formatOperation">删除</th>
						</tr>
					</thead>
				</table>
			</div>
		</form>
		<div id="divdia" style="display: none;"></div>
		<div id="divdia2" style="display: none;"></div>
	</div>

	<script type="text/javascript">

        var industryClassId=${industryClassId};
        var productId=${productId};
		if(productId!=undefined&&industryClassId!=undefined){
            //打开添加品牌型号窗口
           append();
		}
        function deleteInput(obj) {
            console.log(obj.parentElement.parentElement)
            //var  tableObj= document.getElementById("addForm").firstElementChild;
			$(obj.parentElement.parentElement).empty()
        }
        function formatName(value, row, index) {
            [#if currentUser.username=='lwz'||currentUser.username=='admin']
                var val = "<a class='details' title='查看' href='javascript:void(0);' onclick='newTab(\""
                    + row.i_name
                    + "-信息\",\"/admin/basedata/productclass/guanlian.jspx?chanpinId="+
                    row.i_id+"\")' >"+row.i_name+"</a>";
                return val;
            [#else]
                return row.i_name;
            [/#if]

        }
        function openAdd(induId,proId) {
		    industryClassId=induId;
		    productId=proId;
            append();
        }
        function formatupproductclass(value, row, index) {
            [#if currentUser.username=='lwz'||currentUser.username=='admin']
                if(row.p_name){
                    var str='';
                    var val = "<a class='details' title='查看' href='javascript:void(0);' onclick='openAdd("+row.i_id+","+row.p_id+")' >"+row.p_name+"</a>";
                    str=str+val+',';
                    return str.replace(/^,+/,"").replace(/,+$/,"");//正则去掉末尾的逗号
                }else{
                    return "";
                }
            [#else]
                if(row.p_name){
                        return row.p_name
                }else{
                    return  "";
                }
            [/#if]


        }
        function formdate(value, row, index) {
            if(value != null){
                return new Date(value).format("yyyy-MM-dd");
            }
        }
	function submitForm(map) {
        //提交的时候 先判断当前所有品牌是否填完了 填完了就检验是否存在重复的
        var index=$(("#addForm table input[name='model']")).length;
        var flag;
        var repeated;
        $.each($(("#addForm table input[name='model']")),function(index,ele){
            if($(ele).val()==""||$(ele.parentElement.parentElement).children()[1].children[1].children[0].value==""){
                //没有填写完整
                flag= true;
            }else{
                //填写完整
                console.log(brandAndModelList);
                var thisModle=$(ele).val();
                var thisBrand=$(ele.parentElement.parentElement).children()[1].children[1].children[2].value;
                if(brandAndModelList){
                    for(var i=0;i<brandAndModelList.length;i++){
                        if(brandAndModelList[i].model==thisModle&&brandAndModelList[i].productBrandEntity.id==thisBrand){
                            repeated=true;
                            if(!$("#tip")[0]){
                                var trObj = document.createElement("tr");
                                trObj.id="tip";
                                trObj.style.color="red";
                                trObj.innerHTML="<tr style=\"color: red\">\n" +
                                    "                    <th>*</th>\n" +
                                    "                    <td>\n" +
                                    "                       此品牌型号已经添加过了，不可重复添加\n" +
                                    "                    </td>\n" +
                                    "                </tr>";
                                $(ele.parentElement.parentElement).after(trObj)
                            }
                        }
                    }
                }
			}
        });
        if(repeated){
            return false;
		}else{
            $("#tip").remove()
		}
        if(flag){
            alert("请填写完整")
            return false;
        }
		//对表单做校验
        var formflag = $(map["formId"]).form().form('validate');

		var data = {};
		data.productclass=$("#mc_productclass").combobox('getValue');
        data.industryClass=$("#industryClass").combobox('getValue');
		if (formflag) {
			$.Loading.show(map["loadshow"]);
			var options = {
				url : map["url"],
				type : "POST",
				dataType : 'json',
				success : function(result) {
					if (result.result == 1) {
						$.Loading.show(result.message);
						$(map["divDialog"]).dialog('close');
						
						$(map["gridreload"]).datagrid('reload');
						
					}
					if (result.result == 0) {
						$.Loading.error(result.message);
					}
					$.Loading.hide();
				},
				error : function(e) {
					alert("出现错误 ，请重试");
				}
			};
			$(map["formId"]).ajaxSubmit(options);
		}
	}
	
	
	function append(id) {
		var map = {}; // Map map = new HashMap();
		if (!id) {
			map["href"] = "/admin/brandAndModel/add_brandAndModel.jspx";
			map["formId"] = "#addForm";
			map["url"] = "/admin/brandAndModel/doAdd_memberGrade.jspx?ajax=yes";
			map["title"] = "添加信息";
			map["loadshow"] = "正在添加......";
		} else {
			map["href"] = "/admin/mcBrand/edit_memberGrade.jspx?id=" + id;
			map["formId"] = "#editForm";
			map["url"] = "/admin/mcBrand/doEdit_memberGrade.jspx?ajax=yes";
			map["title"] = "修改信息";
			map["loadshow"] = "正修改......";
		}
		map["divDialog"] = "#divdia";
		map["gridreload"] = "#memberdata";
		addDialog(map);
	}
	
	function addDialog(map) {
		$(map["divDialog"]).show();
		$(map["divDialog"]).dialog({
			title : map["title"],
			width : 600,
			height : 400,
			closed : false,
			cache : false,
			href : map["href"],
			modal : true,
			buttons : [ {
				text : '保存',
				iconCls : 'icon-ok',
				handler : function() {
					for(instance in CKEDITOR.instances){
						CKEDITOR.instances[instance].updateElement();
					}
					var savebtn = $(this);
	　　				var disabled=savebtn.hasClass("l-btn-disabled");
	　　				if(!disabled){
						 submitForm(map,savebtn);
					}
				}
			}, {
				text : '清空',
				handler : function() {
					clearForm(map);
				}
			} ],
            onClose:function () {
                productId=undefined;
                industryClassId=undefined;
            }
		});
	}
	
	function clearForm(map) {
		$(map["formId"]).form('clear');
	}

	function formatOperation(value, row, index) {
		if(row.p_name&&row.bmList&&row.bmList.length>0){
			var val = "<a class='edit' title='查看' href='javascript:void(0);' onclick='newTab(\"修改"
				+ row.p_name
				+ "-型号信息\",\"/admin/brandAndModel/deleteModel.jspx?productclass_type=productclassshow&productby="+row.p_name+"&productClassId="+row.p_id+"&industryClassId="
				+row.i_id + "\")' ></a>";
			return val;
		}else if(row.bmList.length==0){
            var val = "<a class='edit' title='查看' href='javascript:void(0);' onclick='alert(\"没有型号\")' ></a>";
            return val;
		}
	}
	function formatStatus(value, row, index) {
		return value == "1" ?"正常":"离职";
	}
	function showTemplate(value, row, index) {
			return "<a class='details' title='查看' href='javascript:void(0);' onclick='newTab(\""
			+ row.templatename
			+ "-模版内容\",\"/admin/userGroupMng/getTemplateContext.jspx?template="
			+ row.templateId + "\")' >"+row.templatename+"</a>";
	}
	
	function del() {
		var rows = $('#memberdata').datagrid("getSelections");
		if (rows.length < 1) {
			$.Loading.error("请选择要删除的");
			return;
		}
		if (!confirm("确认删除选中的信息？")) {
			return;
		}
		var bmIdList=[];
		for(var i=0;i<rows.length;i++){
			for(var j=0;j<rows[i].modelList.length;j++){
                bmIdList.push(rows[i].modelList[j].id)
            }
		}
		
		var options = {
			url : "/admin/brandAndModel/delete_brandAndModel.jspx?ajax=yes",
			type : "POST",
			data:{"bmIdList":bmIdList},
			success : function(result) {
				if (result.result == 1) {
					$.Loading.success(result.message);
					$('#memberdata').datagrid('reload');
				}else{
					$.Loading.error(result.message);
				}
			},
			error : function(e) {
				$.Loading.error("出现错误 ，请重试");
			}
		};
		$('#memberform').ajaxSubmit(options);
	}
        function formatBrandAndModel(value, row, index) {
		    if(row.bmList){
                var str='';
                $.each( row.bmList, function(i,ele){//将有多个的数据，用a标签拼接成多个，用逗号隔开
                    var val = "<a class='details' title='查看' href='javascript:void(0);'>"+ele.b_brand+" "+ele.b_model+"</a>";
                    str=str+val+',';
                });
                return str.replace(/^,+/,"").replace(/,+$/,"");//正则去掉末尾的逗号
			}else{
		        return "";
			}

        }
        function searchIndustryClass(){
            //var keyword = $("#searchKeyword").combobox('getValues');
            //var mode_blame = $("#mode_blame").combobox('getValues');
            //var mc_industry_class = $("#mc_industry_class_all").val();
            //var major_product = $("#major_product_all").val();
            //var mc_productclass = $("#mc_productclass_all").val();
            //var mode_blame = $("#mode_blame").combobox('getValues');
            var create_date = $("#create_date_all").val();
            var productName = $("#productName").combotree('getValues');
            var industryClassName = $("#industryClassName").combobox('getValues');
            var brand = $("#brand").combobox('getValues');

            $("#memberdata").datagrid('options').queryParams = {
                /* keyword:keyword.toString(),
                mode_blame:mode_blame.toString(),
                mc_industry_class:mc_industry_class,
                major_product:major_product,
                mc_productclass:mc_productclass, */
                create_date:create_date,
                brand:brand.toString(),
                model:$("#model").val(),
                productName:productName.toString(),
                industryClassName:industryClassName.toString()

            };
            $("#memberdata").datagrid('reload');
        }
        $("#brand").combobox({
            valueField: 'id',
            textField: 'text',
            url: '/admin/basedata/brand/get_brand_names.jspx',
            required: true,
            multiple: false, //多选
            //editable: false, //是否可编辑
            filter: function (q, row) {
                var opts = $(this).combobox('options');
                return row.text.indexOf(q) >= 0||row.nameEn.toUpperCase().indexOf(q.toUpperCase())>=0;//这里改成>=即可在任意地方匹配
            }
        })
</script>
</body>
</html>