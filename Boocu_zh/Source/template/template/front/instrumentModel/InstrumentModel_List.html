<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>仪器品牌型号</title>
    <script type="text/javascript" src="/adminthemes/new/js/jquery-1.8.3.min.js"></script>
    <script type="text/javascript" src="/adminthemes/new/js/jquery-form-2.33.js"></script>
    <script type="text/javascript" src="/statics/js/area_sql.js"></script>
    <link rel="stylesheet" type="text/css" href="/adminthemes/new/js/easy-ui/themes/gray/easyui.css"/>
    <link rel="stylesheet" type="text/css" href="/adminthemes/new/js/easy-ui/themes/icon.css"/>
    <script type="text/javascript" src="/adminthemes/new/js/easy-ui/jquery.easyui.min.js"></script>
    <script type="text/javascript" src="/adminthemes/new/js/easy-ui/easyui-lang-zh_CN.js"></script>
    <script type="text/javascript" src="/adminthemes/new/js/jquery.blockUI.js"></script>
    <script type="text/javascript" src="/adminthemes/new/js/jquery.loading.js"></script>
    <link href="/adminthemes/new/css/main.css" rel="stylesheet" type="text/css"/>
    <link href="/adminthemes/new/css/style.css" rel="stylesheet" type="text/css"/>
    <script type="text/javascript" src="/adminthemes/js/BooCu.js"></script>
    <script type="text/javascript" src="/adminthemes/new/js/ajaxupload.3.9.js"></script>
    <script type="text/javascript" src="/frontthemes/js/easyuiUtil.js"></script>
    <link rel="stylesheet" href="/statics/front/css/postbirdAlertBox.min.css"/>
    <script type="text/javascript"
            src="/statics/front/js/postbirdAlertBox.min.js"></script>
    <link rel="stylesheet" href="/statics/front/css/user.css"/>
</head>
<body>
<div class="main">
    <form id="memberform">
        <div id="tb" style="height: auto">
            <a href="javascript:append()" class="button blueButton"
               data-options="iconCls:'icon-add',plain:true" onclick="add()">添加</a>
            <a href="javascript:void(0)" class="easyui-linkbutton"
               data-options="plain:true" id="btnDel">删除</a>

            <span style="float: right;">
				<span>
                    仪器品牌：<input class="easyui-combobox combo " type="text"
                                name="brandId"
                                data-options="url:'/brand/get_brand_names.jspx',method:'get',valueField:'id',textField:'text'"
                                style="width: 100px; height: 36px;" id="brand">
                     <input id="model1" class="input_text" type="text" value="" size="15" style="width: 150px;"
                            placeholder="请输入仪器型号" name="instrument_model">
				<span >
				仪器名称：
				 <input style="width: 200px; height: 30px;"
                        class="easyui-combobox"
                        url="/admin/basedata/productclass/combotreeData.json?getSanji=true" name="productName" data-options="multiple:false,valueField:'id',textField:'text',editable:true"
                        id="productName"/>
				</span>
					<a href="javascript:void(0)" class="easyui-linkbutton"
                       data-options="plain:true" onclick="searchOur()">搜索</a>
				</span>
			</span>
        </div>

        <div class="clear height10"></div>
        <div class="shadowBoxWhite tableDiv">
            <table class="easyui-datagrid"
                   data-options="url:'/instrumentModel/list.json',pageList: [5,10,15,20],pageSize:10,fitColumns:'true',nowrap:false"
                   pagination="true" id="memberdata" sortName="id" sortOrder="desc">
                <thead>
                <tr>
                    <th data-options="field:'id',checkbox:true"></th>
                    <th data-options="field:'brandAndName',width:$(this).width()*0.1,sortable:'true'"
                        formatter="fromatBrandModel">仪器品牌型号
                    </th>
                    <th data-options="field:'poption',width:$(this).width()*0.1,sortable:'true'">选件</th>
                    <th data-options="field:'pname',width:$(this).width()*0.1,sortable:'true'">仪器名称</th>
                    <th data-options="field:'industryList',width:$(this).width()*0.1,sortable:'true'"
                        formatter="formatIndustry">产品名称
                    </th>
                    <th data-options="field:'model',width:$(this).width()*0.1,sortable:'true'"
                        formatter="formatManufacturers">厂家型号
                    </th>
                    <th data-options="field:'remark',width:$(this).width()*0.1,sortable:'true'">备注
                    </th>
                    <th data-options="field:'action',width:$(this).width()*0.1,align:'center'"
                        formatter="formatOperation">操作
                    </th>
                </tr>
                </thead>
            </table>
        </div>
    </form>
</div>
<div id="dd" style="display:none;margin: 20px 10px">
    <form id="addForm">
        <input type="hidden" name="instrument_model_id" id="instrument_model_id_add">
        品牌:<input class="easyui-combobox combo " type="text"
                  name="brandId"
                  data-options="url:'/brand/get_brand_names.jspx',method:'get',valueField:'id',textField:'text'"
                  style="width: 100px; height: 36px;" id="brandId"></input>
        型号:<input type="text" name="model" id="model"
                  style="border: 1px #ccc solid;height: 32px;width: 100px;border-radius: 3px">
        选件:<input type="text" name="poption" id="poption"
                  style="border: 1px #ccc solid;height: 32px;width: 100px;border-radius: 3px">
        仪器名称:
        <select style="width: 50px; line-height: 36px; height: 36px;"
                name="yiqiName"
                id="yiqiName"/> </select>

       <div>
           厂家来源：<input type="text" name="remark" id="remark" size="30" style="border: 1px #ccc solid;height: 32px;width: 100px;border-radius: 3px">
           <a href="javascript:void(0)" class="button blueButton"
                data-options="iconCls:'icon-add',plain:true" onclick="doAdd()" id="doAdd" style="display: none;">添加</a>
           <a href="javascript:void(0)" class="button blueButton"
              data-options="iconCls:'icon-add',plain:true" onclick="modify()" id="modify" style="display: none">修改</a>
       </div>

        <div style="margin: 30px 20px;display: inline-block;border: 1px #ccc solid">
            <table id="industryClass"></table>
        </div>
    </form>

</div>
<div id="addModel" style="display:none;margin: 20px 10px">
    <form id="addForm1" method="post" class="validate" action="/instrumentModel/doAddManufacturersModel.jspx">
        <table>
            <tr>
                <th>所属产品名称</th>
                <td>
                    <select style="width: 308px; height: 36px;" class="easyui-combobox" name="industryClass"
                            id="industryClass1"></select>
                    <input type="hidden" name="instrument_model_id" id="instrument_model_id">
                </td>
            </tr>

            <tr>
                <th>厂家</th>
                <td>
                    <input class="input_text easyui-validatebox" style="width: 100px" type="text"
                           name="manufacturers" data-options="required:true"/>
                    型号<input class="input_text easyui-validatebox" style="width: 100px" type="text"
                             name="model" data-options="required:true"/>

                    <a href="javascript:void(0)" class="button blueButton"
                       data-options="iconCls:'icon-add',plain:true" onclick="addInput()">再加一个型号</a>
                </td>
            </tr>
        </table>
        <!--<input type="button" id="model_yincang"   class="input_text2 easyui-validatebox"   value="添加仪器"  onclick="appendmcproductclass()" style="left: 400px;top: 58px;position: absolute;"/>-->
    </form>
    <div style="margin: 30px auto;width: 300px">
        <a href="#" class="easyui-linkbutton" onclick="save()">保存</a>
        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
        <a href="#" class="easyui-linkbutton" onclick="cancel()">取消</a>
    </div>
</div>
<script>

    function searchOur() {
     /*   var create_date = $("#create_date_all").val();
        var productName = $("#productName").combotree('getValues');
        var industryClassName = $("#industryClassName").combobox('getValues');*/
        var brand = $("#brand").combobox('getValue');
        var instrument_model=$("#model1").val();
        var productName = $("#productName").combobox('getValue');

        $("#memberdata").datagrid('options').queryParams = {
            instrument_model:instrument_model,
            brand:brand.toString(),
            productName:productName
        };
        $("#memberdata").datagrid('reload');
    }
    var old_Indu_id_list;
    //修改方法
    function modify() {
        var instrument_model_id_add=$("#instrument_model_id_add").val()
        var brand = $('#brandId').combobox("getValue")
        var model = $("#model").val()
        var poption = $("#poption").val()
        var remark = $("#remark").val()
        var instrument =$('#yiqiName').combotree("getValue")
        if (brand == "" || model == "" || instrument == "") {
            alert("请填写完整")
            return false;
        }
        var chanpinIdList = []
        $("input[name='indu_input_checkboox']:checked").each(function () {
            chanpinIdList.push(parseInt(this.parentElement.parentElement.parentElement.parentElement.getAttribute("node-id")))
        });
        var del_list=old_Indu_id_list.diff(chanpinIdList)
        var add_list=chanpinIdList.diff(old_Indu_id_list)
        console.log("删的"+del_list)
        console.log("添加的"+add_list)
        $.ajax({
             url: "/instrumentModel/doModifyInstrumentModel.jspx",
             data: {"instrument_model_id_add":instrument_model_id_add,"brand":brand,"model":model,"poption":poption,"instrument":instrument,"add_list":add_list,"remark":remark,"del_list":del_list},
             dataType: "json",
             success: function (data) {
                 alert(data.cont);
                 $("#dd").dialog('close')
                 $("#memberdata").datagrid("reload")
             }
         });
    }

    function fromatBrandModel(value, row, index) {
        var str = "<a href=\"javascript:void(0)\" onclick=\"add(" + row.id + ")\">" + row.brandAndName + "</a>";
        return str;
    }

    function save() {
        //提交的时候 先判断当前所有品牌是否填完了 填完了就检验是否存在重复的
        var index = $(("#addForm table input[name='model']")).length;
        var flag;
        var repeated;

        $.each($(("#addModel table input[name='manufacturers']")), function (index, ele) {
            if ( $(ele.parentElement.parentElement).children()[1].children[1].value == "") {
                //没有填写完整
                flag = true;
            } else {
                //填写完整
                console.log(manufacturersAndModelList);
                var thisModle = $(ele).val();
                var thisBrand = $(ele.parentElement.parentElement).children()[1].children[1].value;
                if (manufacturersAndModelList) {
                    for (var i = 0; i < manufacturersAndModelList.length; i++) {
                        if (manufacturersAndModelList[i].model == thisBrand && manufacturersAndModelList[i].manufacturers == thisModle) {
                            repeated = true;
                            if (!$("#tip")[0]) {
                                var trObj = document.createElement("tr");
                                trObj.id = "tip";
                                trObj.style.color = "red";
                                trObj.innerHTML = "<tr style=\"color: red\">\n" +
                                    "                    <th>*</th>\n" +
                                    "                    <td>\n" +
                                    "                       此品牌型号已经添加过了，不可重复添加\n" +
                                    "                    </td>\n" +
                                    "                </tr>";
                                $(ele.parentElement.parentElement).after(trObj);
                            }
                        }
                    }
                }
            }
        });
        if (repeated) {
            return false;
        } else {
            $("#tip").remove()
        }
        if (flag) {
            alert("请填写完整")
            return false;
        }

        $.ajax({
            url: "/instrumentModel/doAddManufacturersModel.jspx",
            data: $('#addForm1').serialize(),
            dataType: "json",
            error: function (data) {
                alert(data.cont);
            },
            success: function (data) {
                alert(data.cont);
                $("#memberdata").datagrid("reload")
                $("#addModel").dialog('close')
            }
        });
    }

    function cancel() {
        $('#addModel').dialog('close')
    }
    //全局变量
    var save_flag = true;
    function doAdd() {
        var brand = $('#brandId').combobox("getValue");
        var model = $('#model').val();
        var poption = $('#poption').val();
        var remark = $('#remark').val();
        var instrument = $('#yiqiName').combotree("getValue");
        if (brand == "" || model == "" || instrument == "") {
            alert("请填写完整")
            return false;
        }
        var chanpinIdList = []
        $("input:checked").each(function () {
            chanpinIdList.push(this.parentElement.parentElement.parentElement.parentElement.getAttribute("node-id"))
        });
        console.log(chanpinIdList)
       /* if (chanpinIdList.length == 0) {
            alert("请选择产品分类")
            return false;
        }*/

        if(!save_flag){
            //不提交
            return;
        }

          $.ajax({
              url: "/instrumentModel/doAdd.jspx",
              data: {
                  "brandId": brand,
                  "model": model,
                  "poption": poption,
                  "instrument": instrument,
                  "chanpinIdList": chanpinIdList,
                  "remark":remark
              },
              dataType: "json",
              type: "POST",
              beforeSend: function(){
                  save_flag = false;
              },
              success: function (result) {
                  save_flag = true;
                  alert(result.cont)
                  $("#dd").dialog('close')
                  $('#addForm').form('clear')
                  $("#memberdata").datagrid("reload")
              }
          });
    }

    function formatManufacturers(value, row, index) {
        var str = "";
        if(row.manufacturersList){
            $.each(row.manufacturersList, function (index, ele) {
                str += "<a href=\"javascript:void(0)\" >" + ele.manufacturers + " " + ele.model + "</a>,";
            })
        }
        return str;
    }

    function formatOperation(value, row, index) {
        var val = "<a class='edit' title='修改' href='javascript:void(0);')' ></a>";
        return val;
    }

    function formatIndustry(value, row, index) {
        var str = "";
        if(value){
            $.each(value, function (index, ele) {
                str += "<a href=\"javascript:void(0)\" onclick=\"openAddDialog(" + row.id + "," + ele.indu_id + ")\">" + ele.name + "</a>,";
            })
        }
        return str;
    }

    function openAddDialog(id, obj_id) {
        $.ajax({
            type: "POST",
            url: "/instrumentModel/getManufacturersAndModelList.json",
            data: "instrument_model_id=" + id + "&industry_id=" + obj_id,
            success: function (data) {
                console.log(data)
                manufacturersAndModelList = data;
            }
        });
        $("#industryClass1").combobox({
            valueField: 'id',
            textField: 'text',
            url: '/admin/industyClass/combotreeData.json?getSanji=true',
            required: true,
            multiple: false, //多选
            onLoadSuccess: function () {
                $("#industryClass1").combobox('select', obj_id)
            }
        })
        $("#addModel").show()
        $('#addModel').dialog({
            title: '添加厂家型号',
            width: 550,
            height: 300,
            closed: false,
            cache: false,
            modal: true,
            onBeforeClose: function () {
                $('#addForm').form('clear')
                var index = $(("#addModel table input[name='manufacturers']")).length;
                if (index > 1) {
                    $.each($(("#addModel table input[name='manufacturers']")), function (index, ele) {
                        if (index > 0) {
                            $(ele.parentElement.parentElement).empty()
                        }
                    });
                }
                $("#tip").remove()
            },
            onOpen: function () {
                $("#instrument_model_id").val(id)
            }
        });
    }

    function add(id) {
        var title = "";
        if (!id) {
            $("#doAdd").show();
            $("#modify").hide();
            title = '添加品牌型号'
        } else {
            $("#doAdd").hide();
            $("#modify").show();
            title = '修改信息'
            $("#instrument_model_id_add").val(id)
        }
        $("#dd").show()
        $('#dd').dialog({
            title: title,
            width: 800,
            height: 600,
            closed: false,
            cache: false,
            modal: true,
            onBeforeClose: function () {
                $('#addForm').form('clear')
            },
            onOpen: function () {
                if(id){
                    $.ajax({
                        url: "/instrumentModel/findById.json",
                        data: {"instrument_model_id":id},
                        dataType: "json",
                        success: function (data) {
                            console.log(data)
                            $("#brandId").combobox("setValue",data.brand_id)
                            $("#model").val(data.model)
                            $("#poption").val(data.poption)
                            $("#yiqiName").combotree("setValue",data.productClass_id)
                            $("#remark").val(data.remark)
                            $.each(data.indu_id_List,function (i,e) {
                                $("table tr[node-id=" + e + "] input")[0].checked=true;
                            })
                            old_Indu_id_list=data.indu_id_List
                        }
                    });
                }
            }
        });
    }

    $(function () {
        $("#btnDel").click(function () {
            var rows = $("#memberdata").datagrid("getSelections")
            if (rows.length < 1) {
                $.Loading.error("请选择要删除的选项");
                return;
            }
            if (!confirm("确认要删除该选项?")) {
                return;
            }
            var InstrumentModelIds = [];
            for (var i = 0; i < rows.length; i++) {
                InstrumentModelIds[i] = rows[i].id;
            }
            var options = {
                url: "/instrumentModel/deleteInstrumentModel.jspx?ajax=yes&instrumentModelIds=" + InstrumentModelIds,
                type: "POST",
                dataType: 'json',
                success: function (result) {
                    $.Loading.success(result.cont);
                    $('#memberdata').datagrid('reload');
                },
                error: function (e) {
                    $.Loading.error("出现错误, 请重试");
                }
            };
            $('#memberdata').ajaxSubmit(options);
        })
        $("select[name='yiqiName']").combotree({
            width: 250,
            method: 'get',
            url: '/instrumentModel/productclass/combotreeData.json',
            editable: false,
            required: true,
            //onlyLeafCheck:true,
            onBeforeSelect: function (node) {
                var tree = $('#yiqiName').combotree('tree');// get the tree object
                if (!$("#yiqiName").combotree("tree").tree('isLeaf', node.target)) {
                    return false;
                }
            }
        });
        //阻止输入没有的品牌
        $("#brandId").combobox({
            filter: function (q, row) {
                var opts = $(this).combobox('options');
                return row.textZh.indexOf(q) >= 0 || row.text.toUpperCase().indexOf(q.toUpperCase()) >= 0;//这里改成>=即可在任意地方匹配
            },
            onHidePanel: function () {
                var valueField = $(this).combobox("options").valueField;
                var val = $(this).combobox("getValue");  //当前combobox的值
                var allData = $(this).combobox("getData");   //获取combobox所有数据
                var result = true;      //为true说明输入的值在下拉框数据中不存在
                for (var i = 0; i < allData.length; i++) {
                    if (val == allData[i][valueField]) {
                        result = false;
                        break;
                    }
                }
                if (result) {
                    PostbirdAlertBox.alert({
                        'title': '提 示',
                        'content': '请选择下拉框中的品牌',
                        'okBtn': '好的',
                        'contentColor': 'blue',
                        'onConfirm': function () {
                        }
                    });
                    $(this).combobox("clear");
                }
            }
        })
        $('#industryClass').treegrid({
            width: "350",
            height: "400",
            url: '/instrumentModel/industyClass/combotreeData.json',
            idField: 'id',
            treeField: 'text',
            lines: true,
            cascadeCheck: false,
            method: 'get',
            rownumbers: true,
            columns: [[
                {
                    title: '选择产品名称', field: 'text', width: 300, formatter: function (value, row, index) {
                    if (row.children) {
                        return value;
                    } else {
                        return "<input onclick='stop(event)' type='checkbox' name='indu_input_checkboox'/>" + value;
                    }
                }
                },
            ]],
            onClickRow: function (row) {
                if (!row.children) {
                    $("table tr[node-id=" + row.id + "] input")[0].checked = $("table tr[node-id=" + row.id + "] input").attr("checked") ? false : true;
                }
            }
        });
    })

    function stop(e) {
        e.stopPropagation();
    }

    var manufacturersAndModelList;

    function addInput() {
        console.log("添加品牌型号")
        //添加多项的时候 先判断当前所有品牌是否填完了 填完了就检验是否存在重复的
        var index = $(("#addModel table input[name='manufacturers']")).length;
        var flag;
        var repeated;
        $.each($(("#addModel table input[name='manufacturers']")), function (index, ele) {
            if ($(ele.parentElement.parentElement).children()[1].children[1].value == "") {
                flag = true;
            } else {
                //填写完整
                console.log(manufacturersAndModelList);
                var thisModle = $(ele).val();
                //此处为厂家名称
                var thisBrand = $(ele.parentElement.parentElement).children()[1].children[1].value;
                if (manufacturersAndModelList) {
                    for (var i = 0; i < manufacturersAndModelList.length; i++) {
                        if (manufacturersAndModelList[i].model ==  thisBrand&& manufacturersAndModelList[i].manufacturers == thisModle) {
                            repeated = true;
                            if (!$("#tip")[0]) {
                                var trObj = document.createElement("tr");
                                trObj.id = "tip";
                                trObj.style.color = "red";
                                trObj.innerHTML = "<tr>\n" +
                                    "                    <th>*</th>\n" +
                                    "                    <td>\n" +
                                    "                       此厂家型号已经添加过了，不可重复添加\n" +
                                    "                    </td>\n" +
                                    "                </tr>";

                                $(ele.parentElement.parentElement).after(trObj)
                            }

                        }

                    }
                    /*//拿到输入的品牌和型号
                    var brands = $("#addForm table input[name='brand']");
                    for(var i=0;i<brands.length;i++){
                        //品牌
                        console.log(brands[i].value)
                        //型号
                        console.log($(brands[i]).parent().next()[0].value)
                        //遍历所有的品牌型号和上面的比对  有重复的提示不可再添加，否则放行

                    }*/
                }

            }
            //$(ele.parentElement.parentElement).empty()
        });
        if (repeated) {
            return false;
        } else {
            $("#tip").remove()
        }
        if (flag) {
            console.log(flag)
            alert("请填写完整")
            return false;
        }
        var index = $(("#addModel table input[name='manufacturers']")).length + 1;
        var trObj = document.createElement("tr");
        trObj.innerHTML = "<th>厂家</th>\n" +
            "                <td>\n" +
            "                    <input class=\"input_text easyui-validatebox\" style=\"width: 100px\" type=\"text\"\n" +
            "                           name=\"manufacturers\" data-options=\"required:true\"/>\n" +
            "                    型号<input class=\"input_text easyui-validatebox\" style=\"width: 100px\" type=\"text\"\n" +
            "                              name=\"model\" data-options=\"required:true\"/>\n" +
            "\n" +
            "                    <a href=\"javascript:void(0)\" class=\"button blueButton\"\n" +
            "                       data-options=\"iconCls:'icon-add',plain:true\" onclick=\"delInput(this)\">删除此项</a>\n" +
            "                </td>";
        $(("#addModel table tr:last-child")).after(trObj)

    }

    function delInput(obj) {
        console.log(obj.parentElement.parentElement)
        if ($("#addModel table input[name='manufacturers']").length < 1) {
            alert("至少保留一个")
            return false;
        }
        //var  tableObj= document.getElementById("addForm").firstElementChild;
        $(obj.parentElement.parentElement).empty()
    }
    //2个集合的差集 在a存在
    Array.prototype.diff = function(a) {
        return this.filter(function(i) {return a.indexOf(i) < 0;});
    };
</script>
</body>
</html>